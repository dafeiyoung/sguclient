#!/bin/sh /etc/rc.common
 
USE_PROCD=1
START=99
STOP=85
PROG=/usr/share/sguclient/sgud.sh

sgud_loader() {

  local enable
  config_get_bool enable $1 enable
  # 有些路由器安装完软件包会自动执行start方法，该判断用于避免还没有设置配置文件导致的错误
  if [ "$enable" != '0' ]; then
      if [ "$enable" -gt 0 2&>1 1>/dev/null ]; then
        rm /tmp/SGU_immortality 2&>1 1>/dev/null
        local logtofile
        local autoreconnect
        local username
        local password
        local isptype
        local ifname
        local cmd
        config_get_bool autoreconnect $1 autoreconnect
        config_get_bool noheartbeat $1 noheartbeat
        config_get username $1 username
        config_get password $1 password
        config_get isptype $1 isptype
        config_get ifname $1 ifname
        config_get_bool logtofile $1 logtofile
        if [ $autoreconnect ];then cmd=$cmd" --auto";fi
        if [ $noheartbeat ];  then cmd=$cmd" --noheartbeat";fi
        if [ $autoreconnect ];then  #如果用户选择不开启重连,那么sgud.sh只会启动一次sguclient
          touch /tmp/SGU_immortality
        fi
        procd_open_instance
        procd_set_param command "$PROG" -u $username -p $password -i $isptype --device $ifname $cmd
        procd_set_param pidfile /var/run/sgud.pid # 可有可无
        procd_set_param respawn 1 1 1
        procd_close_instance
        echo "SGUClient has started."
      else
        rm /tmp/sgud_loader 2&>1 1>/dev/null
        #cat /var/run/sgud.pid | xargs kill -9 #在这里kill会引起procd重启sgud.sh
        killall -q sguclient
              echo "SGUClient has stopped."
      fi
  fi

}
start_service(){

  config_load sguclient
  config_foreach sgud_loader login

}
stop_service(){

	rm /tmp/sgud_loader 2&>1 1>/dev/null
	#cat /var/run/sgud.pid | xargs kill -9
	killall -q sguclient
	echo "SGUClient has stoped."	
	
}
reload_service(){

	stop
	start
	
}
service_triggers(){

   procd_add_reload_trigger sguclient
   
}

